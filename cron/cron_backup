#!/bin/bash
#     ////     //  ////     //
#    // //    //  // //    //
#   //  //   //  //  //   //
#  //   //  //  //   //  //
# //    // //  //    // //
#//     ////  //     ////
#
# 20200512 - Created cron_backup for cronjob
# 20200616 - Added disk confirmation
# 20200701 - Disk mounts within the script
#
#Mount NNVault
mount -t cifs //10.0.100.10/NNVault /nnvault -o credentials=/home/nn/.smbnnvault
#NNVault disk confirmation
if grep -qs '/nnvault ' /proc/mounts; then
  echo "NNVault is Mounted"
  #Create backup_tmp.log and backup_page.log
  echo -n > /home/nn/rsync_logs/backup_tmp.log
  echo -n > /home/nn/rsync_logs/backup_page.log
  #Write initial header
  sh -c 'echo "     ////     //  ////     //" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "    // //    //  // //    //" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "   //  //   //  //  //   //" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "  //   //  //  //   //  //" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo " //    // //  //    // //" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "//     ////  //     ////\n" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "NNBackup ran backup script on `date`\n" >> /home/nn/rsync_logs/backup_page.log'
  #Runs rsync and writes log to backup_tmp.log
  echo "-------------------"
  echo "--[ rSync Files ]--"
  echo "-------------------"
  sh -c 'echo "-------------------" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "--[ rSync Files ]--" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "-------------------" >> /home/nn/rsync_logs/backup_page.log'
  rsync -avh --progress --delete --stats --ignore-existing --ignore-errors -s -e "ssh" --rsync-path="sudo rsync" /nnvault/Files/. /backup1/Files --log-file=/home/nn/rsync_logs/backup_tmp.log
  tail -n 15 /home/nn/rsync_logs/backup_tmp.log | tee -a /home/nn/rsync_logs/backup_page.log
  echo "---------------------"
  echo "--[ rSync Backups ]--"
  echo "---------------------"
  sh -c 'echo "---------------------" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "--[ rSync Backups ]--" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "---------------------" >> /home/nn/rsync_logs/backup_page.log'
  rsync -avh --progress --delete --stats --ignore-existing --ignore-errors -s -e "ssh" --rsync-path="rsync" /nnvault/Backup/. /backup1/Backup --log-file=/home/nn/rsync_logs/backup_tmp.log
  tail -n 15 /home/nn/rsync_logs/backup_tmp.log | tee -a /home/nn/rsync_logs/backup_page.log
  echo "-----------------------"
  echo "--[ rSync VMBackups ]--"
  echo "-----------------------"
  sh -c 'echo "-----------------------" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "--[ rSync VMBackups ]--" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "-----------------------" >> /home/nn/rsync_logs/backup_page.log'
  rsync -avh --progress --delete --stats --ignore-existing --ignore-errors -s -e "ssh" --rsync-path="rsync" /backup1/Backup/VMBackup/backup. /vmbackup/VMBackup/backup --log-file=/home/nn/rsync_logs/backup_tmp.log
  tail -n 15 /home/nn/rsync_logs/backup_tmp.log | tee -a /home/nn/rsync_logs/backup_page.log
  echo "-------------------"
  echo "--[ rSync Music ]--"
  echo "-------------------"
  sh -c 'echo "-------------------" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "--[ rSync Music ]--" >> /home/nn/rsync_logs/backup_page.log'
  sh -c 'echo "-------------------" >> /home/nn/rsync_logs/backup_page.log'
  rsync -avh --progress --delete --stats --ignore-existing --ignore-errors -s -e "ssh" --rsync-path="rsync" /nnvault/Media/Music/. /music/ --log-file=/home/nn/rsync_logs/backup_tmp.log
  tail -n 15 /home/nn/rsync_logs/backup_tmp.log | tee -a /home/nn/rsync_logs/backup_page.log
  #Copy backup_page with date stamp for archive on server
  cp /home/nn/rsync_logs/backup_page.log /home/nn/rsync_logs/backup_"$(date +%Y-%m-%d_%H%M%S)".log
  #Copy backup_page to NNBackup logging folder
  cp /home/nn/rsync_logs/backup_page.log /nnvault/Backup/NNServer/NNBackup/Logs/backup_"$(date +%Y-%m-%d_%H%M%S)".log
else
  echo "Error : NNVault Not Mounted"
fi
#delete temp files
rm /home/nn/rsync_logs/backup_tmp.log
rm /home/nn/rsync_logs/backup_page.log
#Unmount NNVault
umount -t cifs //10.0.100.10/NNVault
#shutsdown the server
/sbin/shutdown -h now